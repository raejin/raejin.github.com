
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <title>EC2 adventurous - WATCH AND LEARN</title>
  <meta http-equiv="Content-Type" Content="text/html; charset=utf-8">
  <meta name="author" content="Rae Liu">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  
  <meta name="description" content="It&#8217;s already July! Omg time flies when it comes to summer time. Update: recently I&#8217;ve been very involved in my internship project. I can &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://raejin.github.com/blog/2013/07/01/ec2-adventurous">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/normalize.css" media="screen" rel="stylesheet" type="text/css">
  <link href="/stylesheets/watch.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link rel="stylesheet" type="text/css" href="//cdn.moot.it/1/moot.css" />
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
  <link href="//fonts.googleapis.com/css?family=Averia+Sans+Libre|Noto+Sans|Arbutus+Slab" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="WATCH AND LEARN" type="application/atom+xml">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="/javascripts/wal.js" type="text/javascript"></script>
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="//cdn.moot.it/latest/moot.min.js"></script>
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39687126-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><aside class="botm">
  <ul>
    <li><a href="/about">/about</a></li>
    <li><a href="/blog/archives">/archives</a></li>
    <li><a href="//twitter.com/liuraejin">/twitter</a></li>
    <li><a href="//github.com/raejin">/github</a></li>
  </ul>
</aside>
<aside class="lft">
  <ul>
    <li><a href="/discuss">/discuss</a></li>
  </ul>
</aside>
<hgroup>
  <h1><a href="/">WATCH AND LEARN</a></h1>
  
    <h2>I learn by doing and seeing</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:raejin.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">EC2 Adventurous</h1>
    
    
      <p class="meta">
        








  


[ <time datetime="2013-07-01T21:38:00-07:00" pubdate data-updated="true">Jul  1, 2013</time> ] 

[ Tags <span class="categories">
  
    <a class='category' href='/blog/categories/geek/'>geek</a>, <a class='category' href='/blog/categories/git/'>git</a>, <a class='category' href='/blog/categories/tools/'>tools</a>
  
</span> ]


        
      </p>
    
  </header>


<div class="entry-content"><p>It&#8217;s already July! Omg time flies when it comes to summer time.</p>

<p>Update: recently I&#8217;ve been very involved in my internship project. I can&#8217;t expose the detail but basically I am working with AngularJS extensively. Though I am still very far from an experienced AngularJS developer, I must say IT IS A BEAUTIFUL WEB FRONT-END FRAMEWORK.</p>

<p>Currently I am working on a project called &#8220;yolyo&#8221; (temporarily name), which is based on an open source forum Discourse. Since Discourse requires quite a bit of computing resources, I decided to use Amazon EC2 as our starting point. As I realized how important it is to configure a virtual instance, I would like to dedicate this post to document all the works I&#8217;ve put into to make things work smoothly.</p>

<p>First of all, I would like to thank BitNami providing one-click Discourse installation to deploy on EC2. Otherwise, I would&#8217;ve still struggled with all the nitty gritty deployment detail.</p>

<h1>How to deploy/update by Git</h1>

<p>This has confused me for a long while. I had been used to deploy virtually everything by drag and drop for so long. Though I&#8217;ve learnt how to use Git to do versioning, I do not know how to setup the cloud server so that I can simply do <code>git push origin master</code> to deploy the changes.</p>

<p>Although I finally figured out how to use Git to deploy remote instance, I realized this workflow doesn&#8217;t work really well with Discourse. Discourse itself already contains a git repo, so I would need to push to a remote repo and deploy the instance by pulling from this remote repo. (If anyone knows a better deployment strategy, please let me know)</p>

<h2>On remote machine</h2>

<p>create a git repo as a transition to deploy to a designated directory</p>

<ol>
<li>Copy local machine public key to the remote server (ec2 instance)</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat ~/.ssh/id_rsa.pub | ssh -i ~/.ssh/amazonKey.pem ubuntu@example.com <span class="s2">&quot;cat &gt;&gt; ~/.ssh/authorized_keys&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Create and initialize a new git repo</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir website.git <span class="o">&amp;&amp;</span> <span class="nb">cd </span>website.git
</span><span class='line'><span class="nv">$ </span>git init --bare
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Configure the post-receive hook in order to put the files into desired directory</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; hooks/post-receive
</span><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="nv">GIT_WORK_TREE</span><span class="o">=</span>/home/ubuntu/website
</span><span class='line'><span class="nb">export </span>GIT_WORK_TREE
</span><span class='line'>git checkout -f
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Make the post-receive file executable</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chmod +x hooks/post-receive
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Configure <code>hooks/post-update</code> file</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This hook does two things:</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#  1. update the &quot;info&quot; files that allow the list of references to be</span>
</span><span class='line'><span class="c">#     queries over dumb transports such as http</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#  2. if this repository looks like it is a non-bare repository, and</span>
</span><span class='line'><span class="c">#     the checked-out branch is pushed to, then update the working copy.</span>
</span><span class='line'><span class="c">#     This makes &quot;push&quot; function somewhat similarly to darcs and bzr.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># To enable this hook, make this file executable by &quot;chmod +x post-update&quot;.</span>
</span><span class='line'>
</span><span class='line'>git update-server-info
</span><span class='line'>
</span><span class='line'><span class="nv">is_bare</span><span class="o">=</span><span class="k">$(</span>git config --get --bool core.bare<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$is_bare&quot;</span> <span class="o">]</span>
</span><span class='line'><span class="k">then</span>
</span><span class='line'>        <span class="c"># for compatibility&#39;s sake, guess</span>
</span><span class='line'>        <span class="nv">git_dir_full</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="nv">$GIT_DIR</span>; <span class="nb">pwd</span><span class="k">)</span>
</span><span class='line'>        <span class="k">case</span> <span class="nv">$git_dir_full</span> in */.git<span class="o">)</span> <span class="nv">is_bare</span><span class="o">=</span><span class="nb">false</span>;; *<span class="o">)</span> <span class="nv">is_bare</span><span class="o">=</span><span class="nb">true</span>;; <span class="k">esac</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>update_wc<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="nv">ref</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Push to checked out branch $ref&quot;</span> &gt;&amp;2
</span><span class='line'>        <span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$GIT_DIR</span>/logs/HEAD <span class="o">]</span>
</span><span class='line'>        <span class="k">then</span>
</span><span class='line'><span class="k">                </span><span class="nb">echo</span> <span class="s2">&quot;E:push to non-bare repository requires a HEAD reflog&quot;</span> &gt;&amp;2
</span><span class='line'>                <span class="nb">exit </span>1
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'><span class="k">        if</span> <span class="o">(</span><span class="nb">cd</span> <span class="nv">$GIT_WORK_TREE</span>; git diff-files -q --exit-code &gt;/dev/null<span class="o">)</span>
</span><span class='line'>        <span class="k">then</span>
</span><span class='line'><span class="k">                </span><span class="nv">wc_dirty</span><span class="o">=</span>0
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'><span class="k">                </span><span class="nb">echo</span> <span class="s2">&quot;W:unstaged changes found in working copy&quot;</span> &gt;&amp;2
</span><span class='line'>                <span class="nv">wc_dirty</span><span class="o">=</span>1
</span><span class='line'>                <span class="nv">desc</span><span class="o">=</span><span class="s2">&quot;working copy&quot;</span>
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'><span class="k">        if </span>git diff-index --cached HEAD@<span class="o">{</span>1<span class="o">}</span> &gt;/dev/null
</span><span class='line'>        <span class="k">then</span>
</span><span class='line'><span class="k">                </span><span class="nv">index_dirty</span><span class="o">=</span>0
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'><span class="k">                </span><span class="nb">echo</span> <span class="s2">&quot;W:uncommitted, staged changes found&quot;</span> &gt;&amp;2
</span><span class='line'>                <span class="nv">index_dirty</span><span class="o">=</span>1
</span><span class='line'>                <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$desc&quot;</span> <span class="o">]</span>
</span><span class='line'>                <span class="k">then</span>
</span><span class='line'><span class="k">                        </span><span class="nv">desc</span><span class="o">=</span><span class="s2">&quot;$desc and index&quot;</span>
</span><span class='line'>                <span class="k">else</span>
</span><span class='line'><span class="k">                        </span><span class="nv">desc</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
</span><span class='line'>                <span class="k">fi</span>
</span><span class='line'><span class="k">        fi</span>
</span><span class='line'><span class="k">        if</span> <span class="o">[</span> <span class="s2">&quot;$wc_dirty&quot;</span> -ne 0 -o <span class="s2">&quot;$index_dirty&quot;</span> -ne 0 <span class="o">]</span>
</span><span class='line'>        <span class="k">then</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Make <code>hooks/post-update</code> executible</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chmod +x post-update
</span></code></pre></td></tr></table></div></figure>


<p>Reference</p>

<ul>
<li><a href="http://www.jeffhoefs.com/2012/09/setup-git-deploy-for-aws-ec2-ubuntu-instance/">Setup git deploy for AWS ec2 Ubuntu instance</a></li>
<li><a href="http://stackoverflow.com/questions/225291/git-upload-pack-command-not-found-how-to-fix-this-correctly">StackOverflow - git-upload-pack: command not found, how to fix this correctly</a></li>
<li><a href="http://alestic.com/2010/10/ec2-ssh-keys">Uploading Personal ssh Keys to Amazon EC2 </a></li>
<li><a href="http://blog.gbinghan.com/2012/05/setting-up-repo-on-amazon-ec2-for-git.html">Setting up Repo on Amazon EC2 for Git Push </a></li>
</ul>

</div>


  <footer>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/05/19/readings-for-the-summer/" title="Previous Post: Readings for the Summer">&laquo; Readings for the Summer</a>
      
      
    </p>
  </footer>
</article>

</div>




      
<a class="moot" title="Testing" href="http://api.moot.it/raejin//blog/2013/07/01/ec2-adventurous/#EC2 adventurous"></a>

    </div>
  </div>
  <footer id="footer" role="contentinfo">
</footer>
  











</body>
</html>
